<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="format-detection" content="telephone=no" />
    <title>éŸ³å£°è¦ç´„ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>éŸ³å£°è¦ç´„ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€è‡ªå‹•ã§è¦ç´„ã‚’ç”Ÿæˆã—ã¾ã™</p>
        <div class="format-info">
          <p><strong>âš ï¸ æ³¨æ„äº‹é …</strong></p>
          <ul>
            <li>WAVãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ¢ãƒãƒ©ãƒ«ï¼ˆ1ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰å½¢å¼ã§éŒ²éŸ³ã—ã¦ãã ã•ã„</li>
            <li>ã‚¹ãƒ†ãƒ¬ã‚ªï¼ˆ2ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰ã®WAVãƒ•ã‚¡ã‚¤ãƒ«ã¯å‡¦ç†ã§ãã¾ã›ã‚“</li>
          </ul>
        </div>
      </header>

      <main>
        <div class="upload-section">
          <form id="uploadForm" enctype="multipart/form-data">
            <div class="file-upload-area" id="uploadArea">
              <input
                type="file"
                id="fileInput"
                name="file"
                accept="audio/*"
                required
              />
              <div class="upload-icon">ğŸ“</div>
              <p class="upload-text">
                ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ã‹ã€ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
              </p>
              <p class="file-info" id="fileInfo"></p>
            </div>
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
              è¦ç´„ã‚’ç”Ÿæˆ
            </button>
          </form>
        </div>

        <div
          class="progress-section"
          id="progressSection"
          style="display: none"
        >
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <p class="progress-text" id="progressText">å‡¦ç†ä¸­...</p>
        </div>

        <div class="result-section" id="resultSection" style="display: none">
          <h2>è¦ç´„çµæœ</h2>
          <div class="result-content" id="resultContent"></div>
          <button class="download-btn" id="downloadBtn">
            çµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          </button>
        </div>

        <div class="error-section" id="errorSection" style="display: none">
          <div class="error-message" id="errorMessage"></div>
        </div>
      </main>

      <footer>
        <p>&copy; 2024 éŸ³å£°è¦ç´„ã‚·ã‚¹ãƒ†ãƒ </p>
      </footer>
    </div>

    <script>
      const fileInput = document.getElementById("fileInput");
      const fileInfo = document.getElementById("fileInfo");
      const uploadForm = document.getElementById("uploadForm");
      const submitBtn = document.getElementById("submitBtn");
      const progressSection = document.getElementById("progressSection");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const resultSection = document.getElementById("resultSection");
      const resultContent = document.getElementById("resultContent");
      const downloadBtn = document.getElementById("downloadBtn");
      const errorSection = document.getElementById("errorSection");
      const errorMessage = document.getElementById("errorMessage");

      let outputFilename = "";

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®å‡¦ç†
      fileInput.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          fileInfo.textContent = `é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (${(
            file.size /
            1024 /
            1024
          ).toFixed(2)} MB)`;
          submitBtn.disabled = false;
        }
      });

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã®å‡¦ç†
      uploadForm.addEventListener("submit", async function (e) {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) {
          alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
          return;
        }

        // UIã®æ›´æ–°
        submitBtn.disabled = true;
        progressSection.style.display = "block";
        resultSection.style.display = "none";
        errorSection.style.display = "none";

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          progressFill.style.width = progress + "%";
          if (progress >= 90) clearInterval(progressInterval);
        }, 500);

        const formData = new FormData();
        formData.append("file", file);

        try {
          // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¨å‡¦ç†
          progressText.textContent = "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...";
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          clearInterval(progressInterval);
          progressFill.style.width = "100%";

          const result = await response.json();

          if (result.success) {
            progressText.textContent = "å®Œäº†ï¼";

            // çµæœã®è¡¨ç¤º
            resultContent.innerHTML = `
                        <div class="transcript-section">
                            <h3>éŸ³å£°èªè­˜çµæœ</h3>
                            <pre>${result.transcript}</pre>
                        </div>
                        <div class="summary-section">
                            <h3>è¦ç´„çµæœ</h3>
                            <pre>${result.summary}</pre>
                        </div>
                    `;

            outputFilename = result.output_file;
            resultSection.style.display = "block";
          } else {
            throw new Error(result.error || "å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }
        } catch (error) {
          errorMessage.textContent = error.message;
          errorSection.style.display = "block";
        } finally {
          submitBtn.disabled = false;
          setTimeout(() => {
            progressSection.style.display = "none";
            progressFill.style.width = "0%";
          }, 2000);
        }
      });

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®å‡¦ç†
      downloadBtn.addEventListener("click", function () {
        if (outputFilename) {
          window.location.href = `/download/${outputFilename}`;
        }
      });

      // PWAå¯¾å¿œ: ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ ã‚’æ”¯æ´
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", function() {
          // ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ã¯ç¾åœ¨æœªå®Ÿè£…ï¼ˆå°†æ¥çš„ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œã‚’è¿½åŠ å¯èƒ½ï¼‰
          // navigator.serviceWorker.register('/static/sw.js');
        });
      }

      // ãƒ›ãƒ¼ãƒ ç”»é¢ã¸ã®è¿½åŠ ç¢ºèªï¼ˆiOSï¼‰
      window.addEventListener('beforeinstallprompt', (e) => {
        // Androidå‘ã‘ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
        e.preventDefault();
      });
    </script>
  </body>
</html>
